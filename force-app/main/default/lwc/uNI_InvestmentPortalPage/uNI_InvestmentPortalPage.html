<template>
  <section class="portal-frame">
    <header class="portal-header">
      <div class="portal-header-main">
        <div class="portal-header-icon">
          <lightning-icon icon-name="standard:account" size="small" alternative-text="Investments"></lightning-icon>
        </div>
        <div class="portal-header-text">
          <p class="portal-eyebrow">Investments</p>
          <h2 class="portal-title">{projectTitle}</h2>
        </div>
      </div>

      <!-- Actions menu mirrors uNI_Incidentbutton (excluding GAD stage buttons as requested). -->
      <template if:true={hasActionMenu}>
        <div class="portal-header-actions">
          <lightning-button-menu
            label="Actions"
            alternative-text="Investment actions"
            onselect={handleActionSelect}
          >
            <template for:each={actionMenuItems} for:item="action">
              <lightning-menu-item
                key={action.value}
                value={action.value}
                label={action.label}
                disabled={action.disabled}
              ></lightning-menu-item>
            </template>
          </lightning-button-menu>
        </div>
      </template>
    </header>

    <nav class="portal-tabs" aria-label="Investment Portal Tabs">
      <template for:each={tabsForRender} for:item="tab">
        <button
          key={tab.id}
          class={tab.cssClass}
          data-id={tab.id}
          onclick={handleTabClick}
          title={tab.label}
        >
          {tab.label}
        </button>
      </template>
    </nav>

    <div class="portal-content">
      <template if:true={activeTab}>
        <c-u-n-i-dynamic-lwc-loader lwc-name={activeTab.lwcName} lwc-params={activeTab.recordId}></c-u-n-i-dynamic-lwc-loader>
      </template>
    </div>
  </section>

  <!-- Incident Flow Modal (from uNI_Incidentbutton) -->
  <template if:true={showFlowModal}>
    <section class="slds-modal slds-fade-in-open" aria-labelledby="incident-flow-modal" role="dialog" tabindex="-1">
      <div class="slds-modal__container">
        <header class="slds-modal__header slds-grid slds-grid_align-spread slds-p-around_small">
          <h2 id="incident-flow-modal" class="slds-text-heading_medium">
            {modalTitle}
          </h2>
          <button class="slds-button slds-button_icon slds-modal__close" title="Close" onclick={closeModal}>
            <lightning-icon icon-name="utility:close" alternative-text="Close" size="small"></lightning-icon>
            <span class="slds-assistive-text">Close</span>
          </button>
        </header>
        <div class="slds-modal__content slds-p-around_medium">
          <lightning-flow
            flow-api-name={flowApiName}
            flow-input-variables={flowInputVariables}
            onstatuschange={handleStatusChange}
          ></lightning-flow>
        </div>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <!-- Add Contributor Flow Modal (from uNI_Incidentbutton) -->
  <template if:true={showFlowModal3}>
    <section class="slds-modal slds-fade-in-open" aria-labelledby="contributor-flow-modal" role="dialog" tabindex="-1">
      <div class="slds-modal__container">
        <header class="slds-modal__header slds-grid slds-grid_align-spread slds-p-around_small">
          <h2 id="contributor-flow-modal" class="slds-text-heading_medium">
            Add New Contributor
          </h2>
          <button class="slds-button slds-button_icon slds-modal__close" title="Close" onclick={closeModal}>
            <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
            <span class="slds-assistive-text">Close</span>
          </button>
        </header>
        <div class="slds-modal__content slds-p-around_medium">
          <lightning-flow
            flow-api-name={flowApiName3}
            flow-input-variables={flowInputVariables}
            onstatuschange={handleStatusChange}
          ></lightning-flow>
        </div>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <!-- Generic Flow Modal (used for Raise Disbursement Request) -->
  <template if:true={showGenericModal}>
    <section class="slds-modal slds-fade-in-open" role="dialog" tabindex="-1">
      <div class="slds-modal__container">
        <header class="slds-modal__header slds-grid slds-grid_align-spread slds-p-around_small">
          <h2 class="slds-text-heading_medium">
            {genericModalHeading}
          </h2>
          <button class="slds-button slds-button_icon slds-modal__close" title="Close" onclick={closeGenericModal}>
            <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
            <span class="slds-assistive-text">Close</span>
          </button>
        </header>
        <div class="slds-modal__content slds-p-around_medium">
          <lightning-flow
            flow-api-name={flowApiName3}
            flow-input-variables={flowInputVariables}
            onstatuschange={handleGenericModalStatusChange}
          ></lightning-flow>
        </div>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>
</template>
