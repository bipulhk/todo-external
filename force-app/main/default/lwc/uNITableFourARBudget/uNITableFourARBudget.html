<template>
  <lightning-card title="Table 4 - By country and output">
    <div class="slds-p-around_small">
      <template if:true={loading}>
        <lightning-spinner alternative-text="Loading" size="small"></lightning-spinner>
      </template>

      <template if:true={error}>
        <div class="slds-text-color_error slds-m-bottom_small">{error}</div>
      </template>

      <template if:true={rows}>
        <div class="slds-scrollable_x">
          <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-m-top_small" role="grid">
            <thead>
              <tr>
                <th rowspan="2"><b>Country</b></th>
                <th colspan="4" class="slds-text-align_center"><b>Total</b></th>
                <template for:each={columns} for:item="col">
                  <th key={col.key} colspan="4" class="slds-text-align_center"><b>{col.label}</b></th>
                </template>
                <th colspan="4" class="slds-text-align_center"><b>Cross-cutting</b></th>
                <th rowspan="2"><b>Variance analysis (AR)</b></th>
              </tr>
              <tr>
                <th>Budget</th>
                <th>Actual</th>
                <th>Variance</th>
                <th>% Implemented</th>
                <template for:each={columns} for:item="col">
                  <th key={col.budgetKey}>Budget</th>
                  <th key={col.actualKey}>Actual</th>
                  <th key={col.varianceKey}>Variance</th>
                  <th key={col.pctKey}>% implemented</th>
                </template>
                <th>Budget</th>
                <th>Actual</th>
                <th>Variance</th>
                <th>% implemented</th>
              </tr>
            </thead>
            <tbody>
              <template for:each={rows} for:item="row">
                <tr key={row.key}>
                  <th scope="row">{row.label}</th>
                  <td><lightning-formatted-number value={row.total.projected} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number></td>
                  <td><lightning-formatted-number value={row.total.actual} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number></td>
                  <td><lightning-formatted-number value={row.total.variance} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number></td>
                  <td>{row.total.pct}</td>

                  <template for:each={row.outputs} for:item="cell">
                    <td key={cell.keyProj}><lightning-formatted-number value={cell.projected} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number></td>
                  <td key={cell.keyAct}>
                    <lightning-input type="number" formatter="currency" value={cell.actual}
                      data-rec-id={cell.recId} data-field={cell.actualField} data-bucket={row.key} data-output={cell.index}
                      onchange={handleActualChange} disabled={isReadOnly}></lightning-input>
                  </td>
                    <td key={cell.keyVar}><lightning-formatted-number value={cell.variance} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number></td>
                    <td key={cell.keyPct}>{cell.pct}</td>
                  </template>
                  <td><lightning-formatted-number value={row.cross.projected} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number></td>
                <td>
                  <lightning-input type="number" formatter="currency" value={row.cross.actual}
                    data-rec-id={row.cross.recId} data-field={row.cross.actualField} data-bucket={row.key} data-output="cross"
                    onchange={handleActualChange} disabled={isReadOnly}></lightning-input>
                </td>
                  <td><lightning-formatted-number value={row.cross.variance} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number></td>
                  <td>{row.cross.pct}</td>

                  <td>
                    <lightning-textarea value={row.varianceAnalysis} readonly rows="2"></lightning-textarea>
                  </td>
                </tr>
              </template>

              <tr class="slds-text-title_bold">
                <th scope="row">Total</th>
                <td><lightning-formatted-number value={summary.total.projected} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number></td>
                <td><lightning-formatted-number value={summary.total.actual} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number></td>
                <td><lightning-formatted-number value={summary.total.variance} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number></td>
                <td>{summary.total.pct}</td>

                <template for:each={summary.outputs} for:item="cell">
                  <td key={cell.keyProj}>
                    <lightning-formatted-number value={cell.projected} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                  </td>
                  <td key={cell.keyAct}>
                    <lightning-formatted-number value={cell.actual} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                  </td>
                  <td key={cell.keyVar}>
                    <lightning-formatted-number value={cell.variance} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                  </td>
                  <td key={cell.keyPct}>{cell.pct}</td>
                </template>
                <td>
                  <lightning-formatted-number value={summary.cross.projected} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                </td>
                <td>
                  <lightning-formatted-number value={summary.cross.actual} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                </td>
                <td>
                  <lightning-formatted-number value={summary.cross.variance} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                </td>
                <td>{summary.cross.pct}</td>

                <td></td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="slds-grid slds-wrap slds-align-spread slds-m-top_medium">
          <div>
            <lightning-button label="Save" variant="brand" onclick={handleSave} disabled={saveDisabled}></lightning-button>
          </div>
          <div class="slds-text-align_right">
            <template if:true={saveMessage}>
              <span class="slds-text-color_success">{saveMessage}</span>
            </template>
            <template if:true={error}>
              <span class="slds-text-color_error">{error}</span>
            </template>
          </div>
        </div>
      </template>

      <template if:false={rows}>
        <div class="slds-text-align_center slds-p-vertical_medium">No expense data found.</div>
      </template>
    </div>
  </lightning-card>
</template>