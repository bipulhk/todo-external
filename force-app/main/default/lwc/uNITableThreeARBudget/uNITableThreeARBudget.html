<template>
  <lightning-card title="Table 3 - Annual Report Budget">
    <div class="slds-p-around_small">
      record id : {recordId}
      <template if:true={loading}>
        <lightning-spinner alternative-text="Loading" size="small"></lightning-spinner>
      </template>

      <template if:true={hasData}>
        <div class="slds-scrollable_x">
          <table class="slds-table slds-table_bordered slds-table_cell-buffer" role="grid">
            <thead>
              <tr>
                <th rowspan="2" class="slds-text-title_caps">Expense group / Outcome</th>
                <template for:each={columns} for:item="col">
                  <th key={col.key} colspan="4" class="slds-text-align_center">{col.label}</th>
                </template>
                <th colspan="4" class="slds-text-align_center">Cross-cutting</th>
                <th rowspan="2" class="narrativeCol">Variance analysis (AR)</th>
              </tr>
              <tr>
                <template for:each={columns} for:item="col">
                  <th key={col.budgetKey}>Budget</th>
                  <th key={col.actualKey}>Actual</th>
                  <th key={col.varianceKey}>Variance</th>
                  <th key={col.pctKey}>% implemented</th>
                </template>
                <th>Budget</th>
                <th>Actual</th>
                <th>Variance</th>
                <th>% implemented</th>
              </tr>
            </thead>
            <tbody>
              <template for:each={table.expenseTypes} for:item="row" for:index="rowIndex">
                <tr key={row.key}>
                  <th scope="row">{row.displayName}</th>
                  <template for:each={row.outputs} for:item="cell">
                    <td key={cell.keyProj}>
                      <lightning-input type="number" formatter="currency" value={cell.projected} disabled></lightning-input>
                    </td>
                    <td key={cell.keyAct}>
                      <lightning-input type="number" formatter="currency" value={cell.actual}
                        data-index={rowIndex} data-output={cell.index} data-api={cell.actualApi} onchange={handleActualChange} disabled={isReadOnly}>
                      </lightning-input>
                    </td>
                    <td key={cell.keyVar}>
                      <lightning-input type="number" formatter="currency" value={cell.variance} disabled></lightning-input>
                    </td>
                    <td key={cell.keyPct}>
                      <lightning-input type="text" value={cell.variancePct} disabled></lightning-input>
                    </td>
                  </template>

                  <td>
                    <lightning-input type="number" formatter="currency" value={row.crosscutting.projected} disabled></lightning-input>
                  </td>
                  <td>
                    <lightning-input type="number" formatter="currency" value={row.crosscutting.actual}
                      data-index={rowIndex} data-output="cross" data-api={row.crosscutting.actualApi} onchange={handleActualChange} disabled={isReadOnly}>
                    </lightning-input>
                  </td>
                  <td>
                    <lightning-input type="number" formatter="currency" value={row.crosscutting.variance} disabled></lightning-input>
                  </td>
                  <td>
                    <lightning-input type="text" value={row.crosscutting.variancePct} disabled></lightning-input>
                  </td>

                  <td class="narrativeCol">
                      <lightning-textarea rows="2" value={row.uNI_VarianceAnalysisAR__c} data-index={rowIndex}
                        data-api="uNI_VarianceAnalysisAR__c" onchange={handleNarrativeChange} disabled={isReadOnly}></lightning-textarea>
                  </td>
                </tr>
              </template>

              <tr class="slds-text-title_bold">
                <th scope="row">Total</th>
                <template for:each={table.summaryOutputs} for:item="cell">
                  <td key={cell.keyProj}>
                    <lightning-formatted-number value={cell.projected} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                  </td>
                  <td key={cell.keyAct}>
                    <lightning-formatted-number value={cell.actual} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                  </td>
                  <td key={cell.keyVar}>
                    <lightning-formatted-number value={cell.variance} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                  </td>
                  <td key={cell.keyPct}>{cell.variancePct}</td>
                </template>
                <td>
                  <lightning-formatted-number value={table.summaryCrosscutting.projected} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                </td>
                <td>
                  <lightning-formatted-number value={table.summaryCrosscutting.actual} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                </td>
                <td>
                  <lightning-formatted-number value={table.summaryCrosscutting.variance} minimum-fraction-digits="2" maximum-fraction-digits="2"></lightning-formatted-number>
                </td>
                <td>{table.summaryCrosscutting.variancePct}</td>
                <td></td>
              </tr>

            </tbody>
          </table>
        </div>
      </template>

      <template if:false={hasData}>
        <div class="slds-text-align_center slds-p-vertical_medium">No expense data found.</div>
      </template>

      <div class="slds-grid slds-wrap slds-align-spread slds-m-top_medium">
        <div>
          <lightning-button label="Save" variant="brand" onclick={handleSave} disabled={saveDisabled}></lightning-button>
        </div>
        <div class="slds-text-align_right">
          <template if:true={saveMessage}>
            <span class="slds-text-color_success">{saveMessage}</span>
          </template>
          <template if:true={error}>
            <span class="slds-text-color_error">{error}</span>
          </template>
        </div>
      </div>
    </div>
  </lightning-card>
</template>